[tools]
go = "latest"
svu = "latest"
changie = "latest"

[tasks.test]
run = "go test ./..."

[tasks.build]
run = """
go build -ldflags "\
  -X hmans.dev/beans/cmd/beans.version=$(git describe --tags --always --dirty 2>/dev/null || echo dev) \
  -X hmans.dev/beans/cmd/beans.commit=$(git rev-parse --short HEAD 2>/dev/null || echo unknown) \
  -X hmans.dev/beans/cmd/beans.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  .
"""

[tasks.install]
depends = "build"
run = "cp beans ~/.local/bin/beans"

[tasks.changelog]
description = "Add a new changelog entry (interactive)"
run = "changie new"

[tasks."release"]
description = "Release with auto-detected version based on changelog entries"
run = """
set -e
# Check for unreleased changes
if [ -z "$(ls -A .changes/unreleased/*.yaml 2>/dev/null)" ]; then
  echo "No unreleased changes found. Add changes with: mise changelog"
  exit 1
fi
NEW_VERSION=$(changie next auto)
echo "Detected version: $NEW_VERSION"
changie batch auto
changie merge
git add CHANGELOG.md .changes/
git commit -m "chore: release $NEW_VERSION"
git tag "$NEW_VERSION"
git push origin main "$NEW_VERSION"
echo "Released $NEW_VERSION"
"""

[tasks."release:patch"]
description = "Release with patch version bump (e.g., v0.1.4 → v0.1.5)"
run = """
set -e
NEW_VERSION=$(changie next patch)
echo "Version: $NEW_VERSION"
changie batch patch
changie merge
git add CHANGELOG.md .changes/
git commit -m "chore: release $NEW_VERSION"
git tag "$NEW_VERSION"
git push origin main "$NEW_VERSION"
echo "Released $NEW_VERSION"
"""

[tasks."release:minor"]
description = "Release with minor version bump (e.g., v0.1.4 → v0.2.0)"
run = """
set -e
NEW_VERSION=$(changie next minor)
echo "Version: $NEW_VERSION"
changie batch minor
changie merge
git add CHANGELOG.md .changes/
git commit -m "chore: release $NEW_VERSION"
git tag "$NEW_VERSION"
git push origin main "$NEW_VERSION"
echo "Released $NEW_VERSION"
"""

[tasks."release:major"]
description = "Release with major version bump (e.g., v0.1.4 → v1.0.0)"
run = """
set -e
NEW_VERSION=$(changie next major)
echo "Version: $NEW_VERSION"
changie batch major
changie merge
git add CHANGELOG.md .changes/
git commit -m "chore: release $NEW_VERSION"
git tag "$NEW_VERSION"
git push origin main "$NEW_VERSION"
echo "Released $NEW_VERSION"
"""
